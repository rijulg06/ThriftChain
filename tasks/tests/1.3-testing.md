# Task 1.3 Testing Instructions
## Write Offer system in Move contract with counter-offer negotiation

### Prerequisites
- Task 1.1 completed: Move contract directory structure exists
- Task 1.2 completed: ThriftItem struct and create_item function implemented
- Sui CLI installed and configured
- Move.toml properly configured with dev addresses

---

## Step 1: Verify Offer Struct Definition

1. **Action to perform**: Check that Offer struct is properly defined in thriftchain.move
2. **Expected output**: Offer struct with fields: id, item_id, buyer, seller, amount, message, status, expires_at, is_counter, created_at
3. **Verification method**: Open `contracts/marketplace/sources/thriftchain.move` and locate the Offer struct
4. **Success criteria**: All required fields present with correct types

---

## Step 2: Verify Event Structs for Offer Lifecycle

1. **Action to perform**: Check that all offer-related event structs are defined
2. **Expected output**: Event structs: OfferCreated, OfferCountered, OfferCancelled, OfferRejected
3. **Verification method**: Search for event struct definitions in thriftchain.move
4. **Success criteria**: All event structs have `copy, drop` abilities and contain relevant fields

---

## Step 3: Verify Marketplace Struct Update

1. **Action to perform**: Check that Marketplace struct includes offers table
2. **Expected output**: Marketplace struct contains `offers: Table<ID, Offer>` and `offer_counter: u64`
3. **Verification method**: Locate Marketplace struct definition
4. **Success criteria**: Offers table and counter field added to marketplace

---

## Step 4: Verify create_offer() Function

1. **Action to perform**: Check create_offer() function implementation
2. **Expected output**: Function with parameters: marketplace, item, amount, message, expires_in_hours, clock, ctx
3. **Verification method**: Locate create_offer function in thriftchain.move
4. **Success criteria**: Function validates inputs, creates offer, adds to marketplace, emits OfferCreated event

---

## Step 5: Verify counter_offer() Function

1. **Action to perform**: Check counter_offer() function implementation
2. **Expected output**: Function with parameters: marketplace, offer, counter_amount, counter_message, clock, ctx
3. **Verification method**: Locate counter_offer function in thriftchain.move
4. **Success criteria**: Function validates seller permission, updates offer with counter details, emits OfferCountered event

---

## Step 6: Verify accept_counter_offer() Function

1. **Action to perform**: Check accept_counter_offer() function implementation
2. **Expected output**: Function with parameters: offer, clock, ctx
3. **Verification method**: Locate accept_counter_offer function in thriftchain.move
4. **Success criteria**: Function validates buyer permission and offer status, marks offer as accepted

---

## Step 7: Verify cancel_offer() Function

1. **Action to perform**: Check cancel_offer() function implementation
2. **Expected output**: Function with parameters: offer, clock, ctx
3. **Verification method**: Locate cancel_offer function in thriftchain.move
4. **Success criteria**: Function validates buyer permission, marks offer as cancelled, emits OfferCancelled event

---

## Step 8: Verify reject_offer() Function

1. **Action to perform**: Check reject_offer() function implementation
2. **Expected output**: Function with parameters: offer, clock, ctx
3. **Verification method**: Locate reject_offer function in thriftchain.move
4. **Success criteria**: Function validates seller permission, marks offer as rejected, emits OfferRejected event

---

## Move Contract Testing (Sui-Specific)

### Unit Tests in Move
- [ ] **Test module structure**: Create `*_tests.move` file in `tests/` directory
- [ ] **Test annotations**: Use `#[test]` and `#[test, expected_failure]` properly
- [ ] **Test scenario usage**: Use `test_scenario::begin()` for complex object interactions
- [ ] **Dummy context**: Use `tx_context::dummy()` for simple function tests
- [ ] **Event testing**: Verify events are emitted using `event::events_by_type<T>()`
- [ ] **Clock testing**: Use `clock::create_for_testing()` for time-dependent functions
- [ ] **Assertions**: Use `assert_eq!` instead of `assert!` with equality checks
- [ ] **Cleanup**: Use `destroy_for_testing()` for proper test cleanup

### Move Test Commands
- [ ] **Run tests**: `sui move test` executes all unit tests
- [ ] **Test specific module**: `sui move test --filter <module_name>`
- [ ] **Test with gas**: `sui move test --gas-budget <amount>`
- [ ] **Test coverage**: `sui move test --coverage` (if available)

### Integration Testing
- [ ] **Local network testing**: Use `sui start` for local development
- [ ] **Testnet deployment**: Deploy to testnet for integration testing
- [ ] **Transaction testing**: Test full transaction flows with real objects
- [ ] **Event subscription**: Test real-time event handling
- [ ] **Gas estimation**: Verify gas costs are reasonable

---

## Success Criteria Checklist

- [ ] Criteria 1: Offer struct defined with all required fields
- [ ] Criteria 2: All offer event structs defined with copy + drop abilities
- [ ] Criteria 3: Marketplace struct updated with offers table
- [ ] Criteria 4: create_offer() function implemented with validation and event emission
- [ ] Criteria 5: counter_offer() function implemented with seller validation
- [ ] Criteria 6: accept_counter_offer() function implemented with buyer validation
- [ ] Criteria 7: cancel_offer() function implemented with buyer validation and event emission
- [ ] Criteria 8: reject_offer() function implemented with seller validation and event emission
- [ ] **Move unit tests pass**: `sui move build --dev` returns success
- [ ] **Integration tests pass**: Full transaction flow works on testnet
- [ ] **Events verified**: All expected events are emitted correctly
- [ ] **Gas costs reasonable**: Transaction gas costs are within acceptable limits

---

## Troubleshooting

### Common Error: "Unresolved addresses found"
**Solution:** Use `sui move build --dev` to build with dev addresses, or configure proper addresses in Move.toml

### Common Error: "Duplicate alias" warnings
**Solution:** These are style warnings and don't affect functionality. Can be ignored for now.

### Common Error: "Unused parameter" warnings
**Solution:** These are style warnings. Parameters like `marketplace` in counter_offer are kept for future use.

### Sui-Specific Errors

#### "TestScenario not properly cleaned up"
**Solution:** Ensure `test_scenario::end()` is called in all test functions

#### "Clock testing functions not available"
**Solution:** Use `clock::create_for_testing()` and related testing functions

#### "Event not found in test"
**Solution:** Use `event::events_by_type<T>()` to query emitted events

#### "Gas budget exceeded"
**Solution:** Increase gas budget or optimize contract functions

---

## Next Steps

After completing Task 1.3, proceed to **Task 1.4**: Write Escrow system in Move contract
