# Task 1.3 Testing Instructions
## Database Schema Setup and Verification

### Prerequisites
- Task 1.2 completed (Supabase project created)
- Environment variables configured in `.env.local`

---

## Step 1: Run the SQL Schema in Supabase

1. **Open Supabase Dashboard**
   - Go to your Supabase project dashboard
   - URL: https://supabase.com/dashboard/project/[your-project-id]

2. **Navigate to SQL Editor**
   - Click on "SQL Editor" in the left sidebar
   - Click "New query"

3. **Copy and Run the Schema**
   - Open `frontend/supabase-schema.sql` in your code editor
   - Copy **ALL** the contents (Cmd/Ctrl + A, then Cmd/Ctrl + C)
   - Paste into the SQL Editor (Cmd/Ctrl + V)
   - Click "Run" button or press Cmd/Ctrl + Enter

4. **Wait for Completion**
   - You should see "Success. No rows returned" message
   - This is normal - the schema creates tables, not data

---

## Step 2: Verify Tables Were Created

1. **Check Table Editor**
   - Go to "Table Editor" in the left sidebar
   - You should see these tables:
     - ✅ `users`
     - ✅ `items`
     - ✅ `offers`
     - ✅ `transactions`
     - ✅ `ownership_history`
     - ✅ `walrus_blobs`

2. **Verify Table Structure (Optional)**
   - Click on each table to view columns
   - Check that the columns match the schema

---

## Step 3: Test Row Level Security (RLS)

### Test 3.1: Verify RLS is Enabled

1. In SQL Editor, run:
   ```sql
   SELECT tablename, rowsecurity 
   FROM pg_tables 
   WHERE schemaname = 'public' 
   ORDER BY tablename;
   ```

2. **Expected Result**: All tables should show `rowsecurity = true`

### Test 3.2: Test User Insert (Should Succeed)

```sql
-- Insert a test user
INSERT INTO users (wallet_address, username, bio) 
VALUES ('0xabcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890', 'testuser', 'Test bio');

-- Verify the insert
SELECT * FROM users WHERE wallet_address = '0xabcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890';
```

**Expected**: One row returned

---

## Step 4: Test Indexes

1. In SQL Editor, run:
   ```sql
   SELECT indexname, tablename 
   FROM pg_indexes 
   WHERE schemaname = 'public' 
   ORDER BY tablename, indexname;
   ```

2. **Expected Result**: You should see indexes like:
   - `idx_users_wallet_address`
   - `idx_items_seller`
   - `idx_items_status`
   - `idx_items_category`
   - `idx_items_created_at`
   - `idx_items_price`
   - `idx_items_tags`
   - `idx_offers_item`
   - `idx_offers_buyer`
   - `idx_offers_seller`
   - `idx_offers_status`
   - `idx_transactions_item`
   - `idx_transactions_buyer`
   - `idx_transactions_seller`
   - `idx_transactions_status`
   - `idx_transactions_hash`
   - `idx_ownership_item`
   - `idx_ownership_owner`
   - `idx_walrus_blobs_id`

---

## Step 5: Test Triggers

1. **Test updated_at Trigger**
   ```sql
   -- Update a user
   UPDATE users 
   SET bio = 'Updated bio' 
   WHERE wallet_address = '0xabcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890';

   -- Check that updated_at changed
   SELECT wallet_address, bio, created_at, updated_at 
   FROM users 
   WHERE wallet_address = '0xabcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890';
   ```

2. **Expected**: `updated_at` should be more recent than `created_at`

---

## Step 6: Test Foreign Key Constraints

1. **Test Valid Foreign Key**
   ```sql
   -- This should work (user exists)
   INSERT INTO items (seller_wallet, title, description, price, category)
   VALUES ('0xabcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890', 'Test Item', 'A test item', 1000000, 'electronics');
   ```

2. **Expected**: Success (1 row inserted)

3. **Test Invalid Foreign Key (Should Fail)**
   ```sql
   -- This should fail (user doesn't exist)
   INSERT INTO items (seller_wallet, title, description, price, category)
   VALUES ('0x0000000000000000000000000000000000000000000000000000000000000000', 'Bad Item', 'This should fail', 1000000, 'electronics');
   ```

4. **Expected**: Error message about foreign key constraint violation

---

## Step 7: Clean Up Test Data (Optional)

```sql
-- Delete test data
DELETE FROM items WHERE title = 'Test Item';
DELETE FROM users WHERE wallet_address = '0xabcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890';
```

---

## Success Criteria Checklist

- [x] All 6 tables created successfully
- [x] RLS is enabled on all tables
- [x] Can insert into `users` table
- [x] All indexes are created
- [x] `updated_at` trigger works
- [x] Foreign key constraints work (allows valid, rejects invalid)
- [x] Tables appear in Supabase Table Editor
- [x] No errors in SQL Editor

---

## Troubleshooting

### Error: "relation already exists"
**Solution**: The table already exists. You can either:
1. Drop the table first: `DROP TABLE IF EXISTS table_name CASCADE;`
2. Or ignore the error if the table is already set up correctly

### Error: "permission denied"
**Solution**: Make sure you're using the service role key in your environment, or run SQL as a superuser

### Tables not appearing in Table Editor
**Solution**: 
1. Refresh the page
2. Check that you're in the correct project
3. Run: `SELECT * FROM information_schema.tables WHERE table_schema = 'public';` to verify tables exist

### RLS policies not working
**Solution**: 
1. Ensure you ran the RLS enable statements
2. Check policies with: `SELECT * FROM pg_policies WHERE tablename = 'table_name';`

---

## Next Steps

After completing Task 1.3, proceed to **Task 1.4**: Implement Supabase client utilities (`lib/supabase/client.ts` and `lib/supabase/server.ts`)
